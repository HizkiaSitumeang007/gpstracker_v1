#include <Wire.h>
#include <Adafruit_SSD1306.h>
#include <TinyGPS++.h>
#include <HardwareSerial.h>
#include "CTBot.h"

#define SCREEN_WIDTH 128
#define SCREEN_HEIGHT 64
#define OLED_RESET -1
#define SCREEN_ADDRESS 0x3C
Adafruit_SSD1306 display(SCREEN_WIDTH, SCREEN_HEIGHT, &Wire, OLED_RESET);

#define RXD2 16
#define TXD2 17
HardwareSerial neogps(1);

TinyGPSPlus gps;
CTBot mybot;

const char* ssid = "koneksi tidak tersedia";
const char* pass = "mengalahkan";
const char* token = "6494604045:AAGZ5OiLjcUYSFx5nthfn-juYsqdLL90Q90";
const int chatId = 1168266140;
int led = 2;

void setup() {
  Serial.begin(115200);
  neogps.begin(9600, SERIAL_8N1, RXD2, TXD2);

  if (!display.begin(SSD1306_SWITCHCAPVCC, SCREEN_ADDRESS)) {
    Serial.println(F("SSD1306 allocation failed"));
    while (true);
  }

  display.clearDisplay();
  display.display();
  delay(2000);

  pinMode(led, OUTPUT);
  Serial.println("Starting telegram bot");
  mybot.wifiConnect(ssid, pass);
  mybot.setTelegramToken(token);

  Serial.println(mybot.testConnection() ? "Connection successful" : "Connection failed");
}

void loop() {
  boolean newData = false;
  for (unsigned long start = millis(); millis() - start < 1000;) {
    while (neogps.available()) {
      if (gps.encode(neogps.read())) {
        newData = true;
      }
    }
  }

  if (newData) {
    Serial.println(gps.satellites.value());
    print_speed();
  } else {
    display.clearDisplay();
    display.setTextColor(SSD1306_WHITE);
    display.setCursor(0, 0);
    display.setTextSize(3);
    display.print("No Data");
    display.display();
  }

  TBMessage msg;
  if (mybot.getNewMessage(msg)) {
    Serial.println("Received message: " + msg.text);
    if (msg.text == "on" || msg.text == "off") {
      digitalWrite(led, msg.text == "on" ? HIGH : LOW);
      mybot.sendMessage(chatId, "LED " + msg.text.capitalize());
    } else if (msg.text == "LOCATION") {
      sendLocation();
    }
  }

  while (neogps.available() > 0) {
    if (gps.encode(neogps.read())) {
      if (gps.location.isValid()) {
        Serial.print("Latitude: ");
        Serial.println(gps.location.lat(), 6);
        Serial.print("Longitude: ");
        Serial.println(gps.location.lng(), 6);
      }
    }
  }
}

void print_speed() {
  display.clearDisplay();
  display.setTextColor(SSD1306_WHITE);
       
  if (gps.location.isValid() == 1)
  {
   //String gps_speed = String(gps.speed.kmph());
    display.setTextSize(1);
    
    display.setCursor(25, 5);
    display.print("Lat: ");
    display.setCursor(50, 5);
    display.print(gps.location.lat(),6);
 
    display.setCursor(25, 20);
    display.print("Lng: ");
    display.setCursor(50, 20);
    display.print(gps.location.lng(),6);
 
    display.setCursor(25, 35);
    display.print("Speed: ");
    display.setCursor(65, 35);
    display.print(gps.speed.kmph());
    
    display.setTextSize(1);
    display.setCursor(0, 50);
    display.print("SAT:");
    display.setCursor(25, 50);
    display.print(gps.satellites.value());
 
    display.setTextSize(1);
    display.setCursor(70, 50);
    display.print("ALT:");
    display.setCursor(95, 50);
    display.print(gps.altitude.meters(), 0);
 
    display.display();
    
  }
  else
  {
    display.clearDisplay();
    display.setTextColor(SSD1306_WHITE);
    display.setCursor(0, 0);
    display.setTextSize(3);
    display.print("No Data");
    display.display();
}
}

void sendLocation() {
  if (gps.location.isValid()) {
    String lat = String(gps.location.lat(), 6);
    String lon = String(gps.location.lng(), 6);

    String message = "https://maps.google.com/?q=" + lat + "," + lon;
    mybot.sendMessage(chatId, message);
    Serial.println("Location sent to Telegram");
  } else {
    mybot.sendMessage(chatId, "Unable to fetch location.");
    Serial.println("Unable to fetch location");
  }
}
